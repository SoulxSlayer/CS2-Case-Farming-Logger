{% extends "base.html" %}
{% block title %}Manage Accounts - CS2 Tracker{% endblock %}

{% block content %}
<h1 class="mb-4">Manage Your CS2 Accounts</h1>

{# --- Add Account Form (Sort Number Removed) --- #}
<div class="card mb-4 bg-dark text-light border-secondary">
    <div class="card-header">Add New Account</div>
    <div class="card-body">
        <form action="{{ url_for('add_tracked_account') }}" method="POST">
            <div class="row g-3 align-items-end">
                <div class="col-md-5"> {# Adjusted width #}
                    <label for="account_name" class="form-label">Account Name (Nickname)</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" id="account_name" name="account_name" required>
                </div>
                <div class="col-md-5"> {# Adjusted width #}
                    <label for="steamid" class="form-label">SteamID64</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" id="steamid" name="steamid" pattern="[0-9]{17}" title="Enter a 17-digit SteamID64" required>
                     <small class="form-text text-muted">This is the long number in your profile URL, e.g., 7656119...</small>
                </div>
                {# Sort number input removed #}
                <div class="col-md-2 text-end"> {# Adjusted width and alignment #}
                     <label class="form-label"> </label> {# Placeholder for alignment #}
                     <button type="submit" class="btn btn-primary btn-sm w-100">Add Account</button>
                </div>
            </div>
        </form>
    </div>
</div>

{# --- Tracked Accounts Table (Modified for Drag & Drop) --- #}
<div class="card bg-dark text-light border-secondary">
     <div class="card-header d-flex justify-content-between align-items-center">
         <span>Your Tracked Accounts (Drag rows to reorder)</span>
         <button id="saveOrderBtn" class="btn btn-success btn-sm" disabled>Save Order</button> {# Save button #}
     </div>
     <div class="card-body">
         <div id="saveOrderStatus" class="mb-2"></div> {# Feedback area #}
         {% if user_accounts %}
         <div class="table-responsive">
             <table class="table table-dark table-striped table-hover table-sm">
                 <thead>
                     <tr>
                         <th style="width: 5%;"><i class="bi bi-grip-vertical"></i></th> {# Handle indicator #}
                         <th>Account Name</th>
                         <th>SteamID64</th>
                         <th>Actions</th>
                     </tr>
                 </thead>
                 <tbody id="accountsTableBody"> {# <-- Added ID #}
                     {% for acc in user_accounts %}
                     {# Added data-account-id attribute to TR #}
                     <tr data-account-id="{{ acc._id }}" style="cursor: grab;">
                         <td><i class="bi bi-grip-vertical"></i></td> {# Handle indicator #}
                         <td>{{ acc.account_name }}</td>
                         <td><a href="https://steamcommunity.com/profiles/{{ acc.steamid }}/inventory/" target="_blank">{{ acc.steamid }}</a></td>
                         <td>
                             <form action="{{ url_for('delete_tracked_account', account_id=acc._id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this account? Progress data associated with it will NOT be deleted.');">
                                 <button type="submit" class="btn btn-outline-danger btn-sm">
                                     <i class="bi bi-trash"></i> Delete
                                 </button>
                             </form>
                         </td>
                     </tr>
                     {% endfor %}
                 </tbody>
             </table>
         </div>
         {% else %}
         <p class="text-center">You haven't added any accounts to track yet.</p>
         {% endif %}
     </div>
</div>
{% endblock %}

{# --- JavaScript Block (Add to end of manage_accounts.html or base.html) --- #}
{% block scripts %}
{{ super() }} {# Include scripts from base.html if extending #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.getElementById('accountsTableBody');
        const saveButton = document.getElementById('saveOrderBtn');
        const statusDiv = document.getElementById('saveOrderStatus');
        let sortableInstance = null;
        let initialOrder = []; // To track if order actually changed

        if (tableBody && saveButton) {
            // Function to get current order of account IDs
            const getCurrentOrder = () => {
                return Array.from(tableBody.querySelectorAll('tr')).map(row => row.dataset.accountId);
            };

             // Store the initial order on load
            initialOrder = getCurrentOrder();

            sortableInstance = new Sortable(tableBody, {
                animation: 150, // ms, animation speed moving items when sorting, `0` — without animation
                handle: 'td:first-child', // Use the first cell (with the grip icon) as the handle
                ghostClass: 'bg-secondary', // Class name for the drop placeholder
                onUpdate: function (/**Event*/evt) {
                    // Enable the save button only if the order has changed
                    const newOrder = getCurrentOrder();
                    saveButton.disabled = (JSON.stringify(newOrder) === JSON.stringify(initialOrder));
                    statusDiv.innerHTML = ''; // Clear status on change
                }
            });

            saveButton.addEventListener('click', function () {
                const orderedIds = getCurrentOrder();

                statusDiv.innerHTML = '<span class="text-info">Saving...</span>';
                saveButton.disabled = true; // Disable while saving

                fetch("{{ url_for('update_account_order') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Add CSRF token header if you implement CSRF protection later
                    },
                    body: JSON.stringify({ ordered_ids: orderedIds })
                })
                .then(response => {
                    if (!response.ok) {
                         // Try to get error message from JSON response body
                         return response.json().then(err => {
                             throw new Error(err.error || `HTTP error! Status: ${response.status}`);
                         });
                     }
                     return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = '<span class="text-success">Order saved successfully!</span>';
                        initialOrder = orderedIds; // Update initial order to the new saved state
                        saveButton.disabled = true; // Stay disabled until next change
                        // Optionally fade out the success message after a few seconds
                        setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
                    } else {
                         statusDiv.innerHTML = `<span class="text-danger">Error: ${data.error || 'Unknown error'}</span>`;
                         saveButton.disabled = false; // Re-enable if save failed but order might still be different
                    }
                })
                .catch(error => {
                    console.error('Error saving order:', error);
                    statusDiv.innerHTML = `<span class="text-danger">Error saving order: ${error.message}</span>`;
                    saveButton.disabled = false; // Re-enable on fetch error
                });
            });
        }
    });
</script>
{% endblock %}